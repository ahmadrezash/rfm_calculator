<!DOCTYPE html>
<html lang="en" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFM Analysis</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.17.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.rtl.min.css" integrity="sha384-gXt9imSW0VcJVHezoNQsP+TNrjYXoGcrqBZJpry9zJt8PCQjobwmhMGaDHTASo9N" crossorigin="anonymous">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
        }
    </style>
</head>
<body>
<nav class="navbar navbar-light" style="background-color: #e3f2fd;">
    <div class="container-fluid justify-content-start">
        <a class="navbar-brand" href="#">
            <!--            <img src="/docs/5.0/assets/brand/bootstrap-logo.svg" alt="" width="30" height="24" class="d-inline-block align-text-top">-->
            RFM Analysis - کاری از احمدرضا شریفیان زاده -
            <a href="https://t.me/AhmadSharifian" aria-valuetext="dd" class="btn btn-primary" type="button"> تلگرام </a>
            <button type="button" class="btn btn-secondary m-3">09198258119</button>

        </a>
    </div>
</nav>

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card text-center">
                <div class="card-header">
                    تحلیل گر RFM
                </div>
                <div class="card-body">
                    <div class="mb-3">
<!--                        <div class="row">-->
<!--                            <div class="col-8">-->
                                <label for="fileInput" class="form-label">آپلود فایل</label>
                                <input class="form-control" type="file" id="fileInput" accept=".xlsx">
<!--                            </div>-->
<!--                            <div class="col-4">-->
                                <a href="./Sales.xlsx" download="sample.xlsx" class="">نمونه ورودی</a>
<!--                            </div>-->

                        </div>
                    </div>

                    <!--                    <a href="#" class="btn btn-primary">Go somewhere</a>-->
                <div class="card-footer text-muted">
                    <button class="btn btn-primary" onclick="generateXLSX()">دریافت تحلیل</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!--<h1>RFM Analysis</h1>-->
<div class="container">
    <div class="row">
        <div class="col">
        </div>
        <div class="col">
            <!--            <div class="card text-center">-->
            <!--                <div class="card-header">-->
            <!--                    RFM Analysis Calculator-->
            <!--                </div>-->
            <!--                <div class="card-body">-->
            <!--                    <div class="mb-3">-->
            <!--                        <label for="fileInput" class="form-label">آپلود فایل</label>-->
            <!--                        <input class="form-control" type="file" id="fileInput" accept=".xlsx">-->
            <!--                    </div>-->
            <!--                    &lt;!&ndash;                    <a href="#" class="btn btn-primary">Go somewhere</a>&ndash;&gt;-->
            <!--                </div>-->
            <!--                <div class="card-footer text-muted">-->
            <!--                    <button class="btn btn-primary" onclick="generateXLSX()">Get RFM Analysis</button>-->
            <!--                </div>-->
            <!--            </div>-->

        </div>
        <div class="col">
        </div>
    </div>
</div>
<!--<input type="file" id="fileInput" accept=".xlsx">-->

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>

<script>
    // Sample orders data
    let orders = [
        // { customer: 'CustomerA', date: '2023-01-01', amount: 100 },
        // { customer: 'CustomerA', date: '2023-01-05', amount: 50 },
        // Add more orders...
    ];

    function handleFileInput(event) {
        const file = event.target.files[0];

        if (file) {
            const reader = new FileReader();

            reader.onload = function (e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const sheetName = workbook.SheetNames[0];
                const sheet = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);

                // Assuming the sheet has columns like 'customer', 'date', 'amount'
                orders = sheet.map(row => ({
                    customer: row.customer,
                    date: row.date,
                    amount: row.amount
                }));
            };

            reader.readAsArrayBuffer(file);
        }
    }

    // Function to calculate RFM values
    function calculateRFM(orders) {
        const rfmData = {};


        orders.forEach(order => {
            const {customer, date, amount} = order;

            // Calculate recency (in days)
            const orderDate = new Date(date);
            const today = new Date();
            const recency = Math.floor((today - orderDate) / (1000 * 60 * 60 * 24));

            // Calculate frequency (number of orders)
            rfmData[customer] = rfmData[customer] || {recency: recency, frequency: 0, monetary: 0, customer: customer};
            rfmData[customer].frequency++;

            // Calculate monetary value
            rfmData[customer].monetary += amount;
        });
        const convertedArray = Object.values(rfmData);
        let all_recency = getFieldValues("recency", convertedArray);
        let all_frequency = getFieldValues("frequency", convertedArray);
        let all_monetary = getFieldValues("monetary", convertedArray);
        let array_len = all_recency.length
        let final_res = []
        convertedArray.forEach(rfmData => {
            const {recency, frequency, monetary, customer} = rfmData;
            const recency_rank = getRank(recency, all_recency, false);
            const frequency_rank = getRank(frequency, all_frequency, true);
            const monetary_rank = getRank(monetary, all_monetary, true);
            let tmp = {
                customer: customer,
                recency_rank: recency_rank / array_len,
                frequency_rank: frequency_rank / array_len,
                monetary_rank: monetary_rank / array_len,
            }
            // tmp["rfm_score"] = Math.round((.3 * recency_rank + .3 * frequency_rank + .4 * monetary_rank) * 100 * 0.05) * 11 / 5
            tmp["rfm_score"] = Math.round((.3 * tmp["recency_rank"] + .3 * tmp["frequency_rank"] + .4 * tmp["monetary_rank"]) * 10000 * 0.05) / 100 * 11 / 5 + 1;
            let lbl = "";
            if (tmp["rfm_score"] > 10) {
                lbl = "Champions";
            } else if (tmp["rfm_score"] >= 9 && tmp["rfm_score"] <= 10) {
                lbl = "Loyal Customers";
            } else if (tmp["rfm_score"] >= 8 && tmp["rfm_score"] <= 9) {
                lbl = "Potential Loyalists";
            } else if (tmp["rfm_score"] >= 7 && tmp["rfm_score"] <= 8) {
                lbl = "New Customers";
            } else if (tmp["rfm_score"] >= 6 && tmp["rfm_score"] <= 7) {
                lbl = "Promising";
            } else if (tmp["rfm_score"] >= 5 && tmp["rfm_score"] <= 6) {
                lbl = "Need Attention";
            } else if (tmp["rfm_score"] >= 4 && tmp["rfm_score"] <= 5) {
                lbl = "About to Sleep";
            } else if (tmp["rfm_score"] >= 3 && tmp["rfm_score"] <= 4) {
                lbl = "At Risk";
            } else if (tmp["rfm_score"] >= 2 && tmp["rfm_score"] <= 3) {
                lbl = "Can't Lose Them";
            } else if (tmp["rfm_score"] >= 1 && tmp["rfm_score"] <= 2) {
                lbl = "Hibernating";
            } else {
                lbl = "Lost";
            }
            tmp['lbl'] = lbl;
            final_res.push(tmp)

        });


        return final_res;
    }

    function getFieldValues(fieldName, list) {
        return list.map(obj => obj[fieldName]);
    }

    function getRank(value, list, asc) {
        // Clone the array to avoid modifying the original
        let sortedList = [];
        if (asc === true) {
            sortedList = [...list].sort((a, b) => a - b);
        } else {
            sortedList = [...list].sort((a, b) => b - a);
        }

        // Find the index of the value in the sorted list
        const index = sortedList.indexOf(value);

        // Return the rank (1-based) or -1 if the value is not in the list
        return index !== -1 ? index + 1 : -1;
    }

    // Function to generate XLSX file
    function generateXLSX() {
        const rfmData = calculateRFM(orders);

        // Create XLSX workbook and worksheet
        const workbook = XLSX.utils.book_new();
        const worksheet = XLSX.utils.json_to_sheet([{customer: '', recency_rank: '', frequency_rank: '', monetary_rank: '', rfm_score: '', lbl: ''}]);

        // Populate the worksheet with RFM data
        // let frm_output = []
        // Object.keys(rfmData).forEach(customer => {
        //     const {recency, frequency, monetary} = rfmData[customer];
        //     frm_output.push({recency: recency, frequency: frequency, monetary: monetary, customer: customer})
        // });
        XLSX.utils.sheet_add_json(worksheet, rfmData);

        // Add the worksheet to the workbook
        XLSX.utils.book_append_sheet(workbook, worksheet, 'RFM_Data');

        // Save the workbook as a file
        XLSX.writeFile(workbook, 'RFM_Analysis.xlsx');
    }

    document.getElementById('fileInput').addEventListener('change', handleFileInput);
</script>
</body>
</html>
